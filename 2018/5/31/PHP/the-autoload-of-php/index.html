<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PHP的自动加载机制 | 我的博客</title>
  <meta name="baidu-site-verification" content="yXEzwss0jm" />
  <meta name="360-site-verification" content="878e013ea1c0235dec34a8b1c676cf65" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="PHP,Laravel,JavaScript,Jquery,Linux,前端博客">
  
  <meta name="description" content="The secret of PHP&apos;s autoload">
<meta name="keywords" content="PHP,autoload">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP的自动加载机制">
<meta property="og:url" content="https://www.xydida.com/2018/5/31/PHP/the-autoload-of-php/index.html">
<meta property="og:site_name" content="我的博客">
<meta property="og:description" content="The secret of PHP&apos;s autoload">
<meta property="og:locale" content="zh">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/__autoload%20example1.png">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/spl_autoload%20example1.png">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/spl_autoload_register%20example1.png">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/spl_autoload_register%20example2.png">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/getLoader%20function.png">
<meta property="og:image" content="http://p8m3309kb.bkt.clouddn.com/load%20undefined%20class%20foo.png">
<meta property="og:updated_time" content="2018-05-31T09:24:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP的自动加载机制">
<meta name="twitter:description" content="The secret of PHP&apos;s autoload">
<meta name="twitter:image" content="http://p8m3309kb.bkt.clouddn.com/__autoload%20example1.png">
  
    <link rel="alternate" href="/atom.xml" title="我的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="../../../../../css/style.css">
  

  
    <!-- CNZZ Analytics -->
    <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1257809326'%3E%3C/span%3E%3Cscript src='https://s95.cnzz.com/z_stat.php%3Fid%3D1257809326' type='text/javascript'%3E%3C/script%3E"));</script>
    <style>
        span#cnzz_stat_icon_1257809326 {display:none;}
    </style>
    <!-- End CNZZ Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../../../../../index.html" id="logo">我的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="../../../../../index.html" id="subtitle">能找到我的也不是等闲之辈</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="../../../../../index.html">Home</a>
        
          <a class="main-nav-link" href="../../../../../archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.xydida.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-the-autoload-of-php" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../../../../2018/5/31/PHP/the-autoload-of-php/" class="article-date">
  <time datetime="2018-05-31T02:10:15.000Z" itemprop="datePublished">2018-05-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../../../../../categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PHP的自动加载机制
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是自动加载？"><a href="#什么是自动加载？" class="headerlink" title="什么是自动加载？"></a>什么是自动加载？</h1><p>​    顾名思义，就是当我们在使用一个东西的时候，如果这个东西还不存在，于是我们所处的环境就自动帮我们把需要的那个东西拿过来供我们使用，通俗地讲就是这个意思。</p>
<h1 id="PHP中的自动加载"><a href="#PHP中的自动加载" class="headerlink" title="PHP中的自动加载"></a>PHP中的自动加载</h1><p>​    我们在开始接触PHP时，会先写一个PHP文件，当项目比较大了，就会写好多PHP文件，在不同的PHP文件中，如果要用到其他PHP文件中的内容，比如实例化其他文件中的类，就会使用到<code>require</code>、<code>include</code>等函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Foo.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bar.php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'Foo.php'</span>;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo;</span><br></pre></td></tr></table></figure>
<p>​    这种方法看起来很好，确实在一些古老的PHP项目中确实是这样做的，比如ECShop，但一旦这个项目变大，并且还使用了面向对象技术，各种各样的类文件多到很难管理时，<code>require</code>、<code>include</code>等技术还方便吗？</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'A.class.php'</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'B.class.php'</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'C.class.php'</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'D.class.php'</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'E.class.php'</span>;</span><br><span class="line"><span class="params">...</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'Z.class.php'</span>;</span><br><span class="line"></span><br><span class="line">$a = <span class="literal">new</span> A;</span><br><span class="line">$b = <span class="literal">new</span> B;</span><br><span class="line"><span class="params">...</span></span><br><span class="line"><span class="params">...</span></span><br></pre></td></tr></table></figure>
<p>​    这么多的<code>require</code>，你不会在一个现代PHP框架中见到。那么，在现代PHP中是怎么解决这种问题的呢？</p>
<p>​    在PHP 5以后，PHP拥有了完善的面向对象部分，PHP中使用了autoload技术来解决在一个文件中include多个PHP脚本。</p>
<h2 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h2><ul>
<li><a href="http://php.net/manual/en/function.autoload.php" target="_blank" rel="noopener">__autoload</a></li>
<li><a href="http://php.net/manual/en/function.spl-autoload.php" target="_blank" rel="noopener">spl_autoload</a></li>
<li><a href="http://php.net/manual/en/function.spl-autoload-register.php" target="_blank" rel="noopener">spl_autoload_register</a></li>
</ul>
<h3 id="autoload"><a href="#autoload" class="headerlink" title="_autoload"></a>_autoload</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>用于加载未定义的类</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@param $class 需要加载的类名</span></span></span><br><span class="line"><span class="comment"><span class="markdown">*/</span></span></span><br><span class="line"><span class="keyword">void</span> __auto(string $<span class="class"><span class="keyword">class</span>)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：此方法已经在PHP 7.2中标记为<em>DEPRECATED</em>，不建议继续使用</p>
</blockquote>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//myClass.php</span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">myClass</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"myClass init'ed successfuly!!!"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line">// index.php</span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($classname)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $filename = <span class="string">"./"</span>. $classname .<span class="string">".php"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">include_once</span>($filename);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$obj = <span class="keyword">new</span> myClass();	<span class="comment">// 输出：myClass init'ed successfuly!!!</span></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="http://p8m3309kb.bkt.clouddn.com/__autoload%20example1.png" alt=""></p>
<p>​    在<code>index.php</code>中我们并没有指明把<code>myClass.php</code>加载进来，但是依然可以实例化<code>myClass</code>对象。</p>
<h3 id="spl-autoload"><a href="#spl-autoload" class="headerlink" title="spl_autoload"></a>spl_autoload</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* __autoload()的默认实现</span></span><br><span class="line"><span class="comment">* @param $class_name 需要被实例化的小写类名或命名空间</span></span><br><span class="line"><span class="comment">* @param $file_extensions 文件扩展名，默认为.inc或.php</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="literal">void</span> spl_autoload ( <span class="built_in">string</span> $class_name <span class="meta">[</span>, <span class="built_in">string</span> $file_extensions = spl_autoload_extensions() <span class="meta">]</span> )</span><br></pre></td></tr></table></figure>
<p>​    该函数是<code>__autoload()</code>函数的默认实现，如果在调用<code>spl_autoload_register()</code>函数时没有设置任何参数，那么此函数将作为默认加载函数被注册，意思是说如果使用<code>spl_autoload_register()</code>来自动加载时，如果没有指定特殊的加载器，那么将通过<code>spl_autoload()</code>来加载。</p>
<p>​    通常使用该函数时，还需要一些其他的函数配合使用，比如<code>set_include_path()</code>、<code>spl_autoload_extensions()</code>等。</p>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class/Foo.class.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Foo init successfully!!!"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line">set_include_path(<span class="string">'class/'</span>);</span><br><span class="line">spl_autoload_extensions(<span class="string">'.class.php'</span>);</span><br><span class="line">spl_autoload(<span class="string">'Foo'</span>);</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo;</span><br></pre></td></tr></table></figure>
<p><img src="http://p8m3309kb.bkt.clouddn.com/spl_autoload%20example1.png" alt=""></p>
<p>​    可以看到，在<code>spl_autoload()</code>中不能对传过来的<code>class_name</code>做一些判断或修改，需要配合其他函数来设置，此时如果想要在自动加载时做一些判断修改，只能使用<code>__autoload()</code>或者下面的<code>spl_autoload_register()</code>。</p>
<h3 id="spl-autoload-register"><a href="#spl-autoload-register" class="headerlink" title="spl_autoload_register"></a>spl_autoload_register</h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 注册一个自动加载器，这个注册的加载器可以替换__autoload()</span><br><span class="line">* @param $autoload_<span class="keyword">function</span> 需要被注册的自动加载函数，如果没有指定，会将spl_autoload()函数注册</span><br><span class="line">* @param $throw 是否允许函数抛出异常，默认为<span class="literal">true</span></span><br><span class="line">* @param $prepend 是否将这个函数加载器放在队列的最前面，默认为<span class="literal">false</span></span><br><span class="line">* @<span class="keyword">return</span> bool</span><br><span class="line">*/</span><br><span class="line">bool spl_autoload_register([ callable $autoload_<span class="keyword">function</span> [, bool $throw = TRUE [, bool $prepend = FALSE ]]])</span><br></pre></td></tr></table></figure>
<p>​    此函数可以可以注册一个带有<code>spl __autoload</code>队列的函数，并且将会启用这个队列。</p>
<h4 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class/Foo.class.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Foo init successfully by spl_autoload_register!!!"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="comment">// 自定义一个加载器，再加载器中可以对参数$class 做一些判断</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">my_autoloader</span><span class="params">($class)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">'classes/'</span> . $class . <span class="string">'.class.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spl_autoload_register(<span class="string">'my_autoloader'</span>);</span><br><span class="line"><span class="comment">// 或者使用一个匿名函数作为加载器</span></span><br><span class="line">spl_autoload_register(<span class="function"><span class="keyword">function</span> <span class="params">($class)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">'class/'</span> . $class . <span class="string">'.class.php'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo;</span><br></pre></td></tr></table></figure>
<p><img src="http://p8m3309kb.bkt.clouddn.com/spl_autoload_register%20example1.png" alt=""></p>
<p>通过命令空间来注册：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Foobar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($class)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $class . <span class="string">" autoloaded by namespace"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spl_autoload_register(<span class="keyword">__NAMESPACE__</span> .<span class="string">'\Foo::test'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> AClass;</span><br></pre></td></tr></table></figure>
<p><img src="http://p8m3309kb.bkt.clouddn.com/spl_autoload_register%20example2.png" alt=""></p>
<p>​    学了这么多，我们知道了什么是自动加载技术。再来回到文章开头，那个不存在的东西就是我们将要实例化的类，我们所处的环境就是PHP这个环境，自动把没有的东西拿过来给我们用就是使用以上技术加载所需要的类文件，以供我们实例化所需。</p>
<h2 id="Laravel中的自动加载"><a href="#Laravel中的自动加载" class="headerlink" title="Laravel中的自动加载"></a>Laravel中的自动加载</h2><h4 id="从Nginx的配置文件说起"><a href="#从Nginx的配置文件说起" class="headerlink" title="从Nginx的配置文件说起"></a>从Nginx的配置文件说起</h4><p>官方建议的Nginx服务配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="attribute">root</span> /example.com/public;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">add_header</span> X-Frame-Options <span class="string">"SAMEORIGIN"</span>;   </span><br><span class="line">    <span class="attribute">add_header</span> X-XSS-Protection <span class="string">"1; mode=block"</span>; </span><br><span class="line">    <span class="attribute">add_header</span> X-Content-Type-Options <span class="string">"nosniff"</span>; </span><br><span class="line"></span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$query_string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> = /favicon.ico &#123; <span class="attribute">access_log</span> <span class="literal">off</span>; <span class="attribute">log_not_found</span> <span class="literal">off</span>; &#125;  </span><br><span class="line">    <span class="attribute">location</span> = /robots.txt  &#123; <span class="attribute">access_log</span> <span class="literal">off</span>; <span class="attribute">log_not_found</span> <span class="literal">off</span>; &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /index.php;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">fastcgi_split_path_info</span><span class="regexp"> ^(.+\.php)(/.+)$</span>;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> unix:/var/run/php/php7.1-fpm.sock;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /\.(?!well-known).*</span> &#123;</span><br><span class="line">        <span class="attribute">deny</span> all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于该配置为详细说明，就不在此说了，有兴趣的可以查看这篇文章：<a href="https://segmentfault.com/a/1190000011404105" target="_blank" rel="noopener">Laravel 5.5 官方推荐 Nginx 配置学习</a> 。从配置文件中发现Laravel项目的入口文件是<code>public/index.php</code>，于是，就从该文件开始分析。</p>
<p>public/index.php文件中：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">| Register The Auto Loader</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">|</span><br><span class="line">| Composer provides a convenient, automatically generated <span class="built_in">class</span> loader <span class="keyword">for</span></span><br><span class="line">| our <span class="built_in">application</span>. We just need <span class="keyword">to</span> utilize <span class="keyword">it</span>! We'll simply require <span class="keyword">it</span></span><br><span class="line">| <span class="keyword">into</span> <span class="keyword">the</span> <span class="keyword">script</span> here so <span class="keyword">that</span> we don't have <span class="keyword">to</span> worry <span class="keyword">about</span> manual</span><br><span class="line">| loading any <span class="keyword">of</span> our classes later <span class="keyword">on</span>. It feels nice <span class="keyword">to</span> relax.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">require __DIR__.'/../bootstrap/autoload.php';</span><br></pre></td></tr></table></figure>
<p>可以看到，在入口文件中引入了<code>bootstrap/autoload.php</code>这个文件，根据文件名可以大致猜出和自动加载有点关系，而且看注释，就是使用了<code>Composer</code>的自动加载，因为Laravel本身会从<code>vendor</code>目录引用很多第三方库，继续看<code>bootstrap/autoload.php</code>。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">| Register The Composer Auto Loader</span><br><span class="line">|<span class="comment">--------------------------------------------------------------------------</span></span><br><span class="line">|</span><br><span class="line">| Composer provides a convenient, automatically generated <span class="built_in">class</span> loader</span><br><span class="line">| <span class="keyword">for</span> our <span class="built_in">application</span>. We just need <span class="keyword">to</span> utilize <span class="keyword">it</span>! We'll require <span class="keyword">it</span></span><br><span class="line">| <span class="keyword">into</span> <span class="keyword">the</span> <span class="keyword">script</span> here so <span class="keyword">that</span> we do <span class="keyword">not</span> have <span class="keyword">to</span> worry <span class="keyword">about</span> <span class="keyword">the</span></span><br><span class="line">| loading <span class="keyword">of</span> any our classes <span class="string">"manually"</span>. Feels great <span class="keyword">to</span> relax.</span><br><span class="line">|</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">require __DIR__.'/../vendor/autoload.php';</span><br></pre></td></tr></table></figure>
<p>在<code>bootstrap/autoload.php</code>文件中引入了<code>vendor/autoload.php</code>，<code>vendor/</code>里面保存的是第三方库，继续查看<code>vendor/autoload.php</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// autoload.php @generated by Composer</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer/autoload_real.php'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">return</span> ComposerAutoloaderInit9794f3f3ddfd00f32b75ea45e287b507::getLoader();</span></span><br></pre></td></tr></table></figure>
<p>只有两行代码，一个是引入<code>vendor/composer/autoload_real.php</code>，最后调用<code>ComposerAutoloaderInit9794f3f3ddfd00f32b75ea45e287b507::getLoader()</code>返回，看到这里知道既然从这里返回，那么<code>getLoader()</code>方法里面肯定做了一些自动加载的事情。查看该方法。</p>
<p><img src="http://p8m3309kb.bkt.clouddn.com/getLoader%20function.png" alt=""></p>
<p>这是一个静态方法，首先检查静态属性loader是否被实例化，如果已经实例化了则直接返回，否则继续执行下面的代码，很明显这是一个单例模式，Laravel项目中每次只保留一个loader。接下来就用到了<code>spl_autoload_register()</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册loadClassLoader加载器</span></span><br><span class="line">spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit9794f3f3ddfd00f32b75ea45e287b507'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 创建一个loadClassLoader实例</span></span><br><span class="line"><span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br></pre></td></tr></table></figure>
<p>可以看到，先是注册了一个函数名叫<code>loadClassLoader</code>的加载器，再通过这个加载器开始类的加载。看一下这个加载器的实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span><span class="params">($class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === $class) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/ClassLoader.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单，就是判断要加载的不是<code>Composer\Autoload\ClassLoader</code>这个类，如果是就引入该类，否则什么也不做，这就是自动加载。</p>
<p>我们来检验一下，分析的是否正确，修改<code>loadClassLoader()</code>函数如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static <span class="keyword">function</span> loadClassLoader(<span class="variable">$class</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="regexp">//</span> 引入Foo这个类</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Foo'</span> === <span class="variable">$class</span>) &#123;</span><br><span class="line">        echo <span class="string">'Foo from loadClassLoader'</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'Composer\Autoload\ClassLoader'</span> === <span class="variable">$class</span>) &#123;</span><br><span class="line">         require __DIR__ . <span class="string">'/ClassLoader.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>getLoader()</code>中添加一段代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLoader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 单例模式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> !== <span class="keyword">self</span>::$loader) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$loader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册loadClassLoader加载器</span></span><br><span class="line">    spl_autoload_register(<span class="keyword">array</span>(<span class="string">'ComposerAutoloaderInit9794f3f3ddfd00f32b75ea45e287b507'</span>, <span class="string">'loadClassLoader'</span>), <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 创建一个loadClassLoader实例</span></span><br><span class="line">    <span class="keyword">self</span>::$loader = $loader = <span class="keyword">new</span> \Composer\Autoload\ClassLoader();</span><br><span class="line">    <span class="comment">// 创建为定义的类的实例</span></span><br><span class="line">    $foo = <span class="keyword">new</span> Foo;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<p><img src="http://p8m3309kb.bkt.clouddn.com/load%20undefined%20class%20foo.png" alt=""></p>
<p>运行结果和我们猜想的一样。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    学习了PHP自动加载技术，发现其实一点也不神奇，主要就是依靠<code>spl_autoload_register()</code>和<code>spl_autoload()</code>函数，底层还是使用了<code>include</code>的方式，所谓的自动，只是不需要我们每次都在PHP文件的顶部写很多<code>include</code>命令，只要把使用了自动加载函数的文件引入进来，当执行到未定义的类时，就会自动引入相关的类文件。为达到效果，其实也完全可以用一个循环来引入所需要的类，只是在循环引用前，需要把类名和类所在的文件做一个映射，但这样做完全没有使用自动加载函数来的优雅，而且还不灵活，还没有使用到命名空间。</p>
<p>参考：<a href="http://php.net/manual/en/language.oop5.autoload.php" target="_blank" rel="noopener">http://php.net/manual/en/language.oop5.autoload.php</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.xydida.com/2018/5/31/PHP/the-autoload-of-php/" data-id="ckfaj9zof002m33cat5nm18wl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../../tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../../tags/autoload/">autoload</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../../../../2018/6/1/Object-Oriented/rethinking-in-Object-Oriented/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          面向对象的再思考
        
      </div>
    </a>
  
  
    <a href="../../../../../2018/5/15/Linux/Use-screen-to-manage-your-remote-session/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">使用Screen管理远程回话</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Devops/">Devops</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Electron/">Electron</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Networks/">Networks</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Object-Oriented/">Object Oriented</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Regular-Expression/">Regular Expression</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/Tools/">Tools</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/frontend/">frontend</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/notes/">notes</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/小程序/">小程序</a></li><li class="category-list-item"><a class="category-list-link" href="../../../../../categories/微信/">微信</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../../../../../tags/C/" style="font-size: 10px;">C#</a> <a href="../../../../../tags/CSS/" style="font-size: 13.33px;">CSS</a> <a href="../../../../../tags/Go/" style="font-size: 10px;">Go</a> <a href="../../../../../tags/Java/" style="font-size: 10px;">Java</a> <a href="../../../../../tags/Javascript/" style="font-size: 10px;">Javascript</a> <a href="../../../../../tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="../../../../../tags/Linux/" style="font-size: 13.33px;">Linux</a> <a href="../../../../../tags/MySQL/" style="font-size: 13.33px;">MySQL</a> <a href="../../../../../tags/Object-Oriented/" style="font-size: 10px;">Object Oriented</a> <a href="../../../../../tags/Objective-C/" style="font-size: 10px;">Objective-C</a> <a href="../../../../../tags/PHP/" style="font-size: 20px;">PHP</a> <a href="../../../../../tags/PHPStorm/" style="font-size: 10px;">PHPStorm</a> <a href="../../../../../tags/PSR/" style="font-size: 10px;">PSR</a> <a href="../../../../../tags/Perl/" style="font-size: 10px;">Perl</a> <a href="../../../../../tags/Python/" style="font-size: 10px;">Python</a> <a href="../../../../../tags/Reflection/" style="font-size: 10px;">Reflection</a> <a href="../../../../../tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="../../../../../tags/SICP/" style="font-size: 10px;">SICP</a> <a href="../../../../../tags/Server/" style="font-size: 13.33px;">Server</a> <a href="../../../../../tags/Something/" style="font-size: 10px;">Something</a> <a href="../../../../../tags/Swift/" style="font-size: 10px;">Swift</a> <a href="../../../../../tags/Tmux/" style="font-size: 10px;">Tmux</a> <a href="../../../../../tags/VB-NET/" style="font-size: 10px;">VB.NET</a> <a href="../../../../../tags/Vue/" style="font-size: 10px;">Vue</a> <a href="../../../../../tags/autoload/" style="font-size: 10px;">autoload</a> <a href="../../../../../tags/canvas/" style="font-size: 10px;">canvas</a> <a href="../../../../../tags/cover-view/" style="font-size: 13.33px;">cover-view</a> <a href="../../../../../tags/efficiency/" style="font-size: 10px;">efficiency</a> <a href="../../../../../tags/electron/" style="font-size: 10px;">electron</a> <a href="../../../../../tags/interviews/" style="font-size: 10px;">interviews</a> <a href="../../../../../tags/networks/" style="font-size: 10px;">networks</a> <a href="../../../../../tags/notes/" style="font-size: 10px;">notes</a> <a href="../../../../../tags/routing/" style="font-size: 10px;">routing</a> <a href="../../../../../tags/tools/" style="font-size: 10px;">tools</a> <a href="../../../../../tags/小程序/" style="font-size: 16.67px;">小程序</a> <a href="../../../../../tags/微信/" style="font-size: 10px;">微信</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../../archives/2017/10/">October 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../../../../../2020/9/20/小程序/cover-view-2/">小程序cover-view踩坑系列2</a>
          </li>
        
          <li>
            <a href="../../../../../2020/9/20/小程序/cover-view/">小程序cover-view踩坑</a>
          </li>
        
          <li>
            <a href="../../../../../2020/8/9/Electron/unable-download-electron/">Electron踩坑</a>
          </li>
        
          <li>
            <a href="../../../../../2020/5/17/frontend/design-a-swiper-by-CSS/">纯CSS实现轮播图</a>
          </li>
        
          <li>
            <a href="../../../../../2020/5/10/微信/jssdk-invalid-signature/">微信jssdk踩坑—invalid signature</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 bilberry<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="../../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../../archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="../../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../../js/script.js"></script>

  </div>
</body>
</html>